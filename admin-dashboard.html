<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Baby Shower</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    @media (max-width: 640px) {
      body {
        padding: 12px;
      }
    }

    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .dashboard-header {
      background: white;
      padding: 24px 28px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: stretch;
    }

    .dashboard-header-content {
      flex: 1;
      text-align: center;
    }

    .dashboard-header h1 {
      margin: 0 0 10px 0;
      color: #333;
      font-size: 2.2rem;
    }

    .dashboard-header p {
      color: #666;
      margin: 0;
      font-size: 1rem;
    }

    @media (max-width: 768px) {
      .dashboard-header {
        padding: 20px;
      }

      .dashboard-header h1 {
        font-size: 1.8rem;
      }

      .dashboard-header p {
        font-size: 0.95rem;
      }
    }

    @media (max-width: 640px) {
      .dashboard-header {
        padding: 16px;
      }

      .dashboard-header h1 {
        font-size: 1.5rem;
      }

      .dashboard-header p {
        font-size: 0.9rem;
      }
    }

    .logout-btn {
      background: white;
      color: #667eea;
      padding: 10px 20px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }

    .logout-btn svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
    }

    .logout-btn:hover {
      background: #f3f4f6;
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    @media (min-width: 641px) {
      .logout-btn {
        width: auto;
      }
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 30px;
    }

    .invitation-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }

    .invitation-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.2);
    }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .invitation-card {
        padding: 20px;
      }

      .invitation-card:hover {
        transform: translateY(-4px);
      }
    }

    @media (max-width: 640px) {
      .dashboard-grid {
        gap: 12px;
      }

      .invitation-card {
        padding: 16px;
      }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .card-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #333;
      margin: 0;
      flex: 1;
      min-width: 150px;
    }

    .card-color {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      flex-shrink: 0;
    }

    @media (max-width: 640px) {
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .card-title {
        font-size: 1.3rem;
        width: 100%;
      }

      .card-color {
        width: 32px;
        height: 32px;
      }
    }

    .card-info {
      margin-bottom: 16px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.95rem;
      color: #666;
      gap: 12px;
      flex-wrap: wrap;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 600;
      color: #333;
      min-width: 80px;
    }

    @media (max-width: 640px) {
      .info-row {
        flex-direction: column;
        gap: 4px;
      }

      .info-label {
        font-size: 0.85rem;
      }
    }

    .confirmations-badge {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 12px;
    }

    .card-actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #eee;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      min-width: 100px;
    }

    .btn svg {
      width: 16px;
      height: 16px;
      stroke: currentColor;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-tertiary {
      background: #f3f4f6;
      color: #333;
      border: 1px solid #e5e7eb;
    }

    .btn-tertiary:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
    }

    @media (max-width: 640px) {
      .card-actions {
        flex-direction: column;
        gap: 8px;
      }

      .btn {
        width: 100%;
        padding: 12px;
        font-size: 0.85rem;
      }

      .btn svg {
        width: 14px;
        height: 14px;
      }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .empty-state-icon {
      margin-bottom: 16px;
    }

    .empty-state-icon svg {
      width: 48px;
      height: 48px;
      color: #667eea;
      stroke: currentColor;
    }

    .icon-inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .icon-inline svg {
      width: 16px;
      height: 16px;
      stroke: currentColor;
    }

    .empty-state h2 {
      color: #333;
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .empty-state p {
      color: #999;
      margin: 0;
    }

    .loading-spinner {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    .loading-spinner.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f0f0f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    @media (max-width: 640px) {
      .modal-content {
        padding: 20px;
        max-width: 95%;
        border-radius: 10px;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #333;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .confirmation-item {
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid #667eea;
    }

    .confirmation-name {
      font-weight: 600;
      color: #333;
      margin: 0 0 4px 0;
    }

    .confirmation-details {
      font-size: 0.9rem;
      color: #666;
      margin: 0;
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: #f5f6fb;
      color: #667eea;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.12);
      width: 100%;
      justify-content: center;
    }

    .back-button svg {
      width: 16px;
      height: 16px;
      stroke: currentColor;
    }

    .back-button:hover {
      background: white;
      border-color: #667eea;
      transform: translateY(-2px);
    }

    @media (min-width: 641px) {
      .back-button {
        width: auto;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner"></div>
  </div>

  <div class="dashboard-container">
    <div class="dashboard-header">
      <a href="index.html" class="back-button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        Inicio
      </a>

      <div class="dashboard-header-content">
        <h1 class="icon-inline">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <rect x="3" y="3" width="7" height="7" rx="1" />
            <rect x="14" y="3" width="7" height="7" rx="1" />
            <rect x="14" y="14" width="7" height="7" rx="1" />
            <rect x="3" y="14" width="7" height="7" rx="1" />
          </svg>
          Admin Dashboard
        </h1>
        <p>Gestiona todas tus invitaciones de Baby Shower</p>
        <div style="display: flex; align-items: center; gap: 12px; margin-top: 16px; justify-content: center;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; background: #f3f4f6; padding: 10px 16px; border-radius: 8px; transition: all 0.3s ease; user-select: none;" onmouseover="this.style.backgroundColor='#e5e7eb'" onmouseout="this.style.backgroundColor='#f3f4f6'">
            <input type="checkbox" id="filterActive" style="width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;" />
            <span style="color: #333; font-weight: 500; font-size: 14px;">Mostrar s√≥lo activas</span>
          </label>
        </div>
      </div>

      <button class="logout-btn" onclick="handleLogout()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Salir
      </button>
    </div>

    <div id="dashboardContent"></div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Confirmaciones</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalBody"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
  <script src="firebase.js"></script>
  <script>
    function icon(name) {
      switch (name) {
        case 'grid':
          return '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>';
        case 'clipboard':
          return '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 2h-2.18A3 3 0 0 0 10 0H8a3 3 0 0 0-2.82 2H3a1 1 0 0 0-1 1v18a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3V3a1 1 0 0 0-1-1h-2.18A3 3 0 0 0 16 0h-2a3 3 0 0 0 1 2Zm-1 2h-4V3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1Z"/></svg>';
        case 'alert':
          return '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.88 2.36a1.5 1.5 0 0 0-2.76 0L1.14 19.5A1.5 1.5 0 0 0 2.5 21.75h19a1.5 1.5 0 0 0 1.36-2.25ZM11 9h2v5h-2Zm0 6h2v2h-2Z"/></svg>';
        case 'phone':
          return '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 16.5a3.5 3.5 0 0 0-3-3.45 1 1 0 0 0-1 .25l-2 2a15 15 0 0 1-6.3-6.3l2-2a1 1 0 0 0 .25-1 3.5 3.5 0 0 0-3.45-3A2 2 0 0 0 5 3.5C5 13 11 19 20.5 19a2 2 0 0 0 .5-1.5Z"/></svg>';
        case 'chat':
          return '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 3h16a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H8l-4 4V5a2 2 0 0 1 2-2Z"/></svg>';
        case 'list':
          return '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h2v2H4Zm4 0h12v2H8Zm-4 5h2v2H4Zm4 0h12v2H8Zm-4 5h2v2H4Zm4 0h12v2H8Z"/></svg>';
        case 'link':
          return '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M10.59 13.41a1 1 0 0 0 1.41 0l2.83-2.83a1 1 0 0 0-1.41-1.41l-2.83 2.83a1 1 0 0 0 0 1.41Zm-2.12 3.54a4 4 0 0 1 0-5.66l2.12-2.12a1 1 0 0 0-1.41-1.41l-2.12 2.12a6 6 0 0 0 8.49 8.49l2.12-2.12a1 1 0 1 0-1.41-1.41l-2.12 2.12a4 4 0 0 1-5.66 0Zm11.18-9.9a6 6 0 0 0-8.49 0l-2.12 2.12a1 1 0 1 0 1.41 1.41l2.12-2.12a4 4 0 0 1 5.66 5.66l-2.12 2.12a1 1 0 0 0 1.41 1.41l2.12-2.12a6 6 0 0 0 0-8.49Z"/></svg>';
        default:
          return '';
      }
    }

    function hideLoadingSpinner() {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) spinner.classList.add('hidden');
    }

    function showLoadingSpinner() {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) spinner.classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('visible');
    }
    function formatExpiry(ts) {
      try {
        const d = new Date(ts);
        return d.toLocaleString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      } catch (_) {
        return '';
      }
    }
    function daysRemaining(ts) {
      const ms = ts - Date.now();
      if (ms <= 0) return 0;
      return Math.ceil(ms / (24 * 60 * 60 * 1000));
    }

    // Verificar autenticaci√≥n
    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'admin-login.html';
      }
    });

    // Funci√≥n para cerrar sesi√≥n
    function handleLogout() {
      if (confirm('¬øEst√°s seguro de que deseas salir?')) {
        firebase.auth().signOut().finally(() => {
          window.location.href = 'admin-login.html';
        });
      }
    }

    async function loadDashboard() {
      showLoadingSpinner();
      try {
        const onlyActive = document.getElementById('filterActive') ? document.getElementById('filterActive').checked : false;
        const invitations = await db.ref('invitations').once('value').then(snap => {
          const data = snap.val();
          if (!data) return [];
          return Object.entries(data).map(([id, inv]) => ({id, ...inv}));
        });

        const filtered = onlyActive ? invitations.filter(inv => !inv.tokenExpiresAt || Date.now() <= inv.tokenExpiresAt) : invitations;

        if (filtered.length === 0) {
          document.getElementById('dashboardContent').innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">${icon('clipboard')}</div>
              <h2>${onlyActive ? 'No hay invitaciones activas' : 'Sin invitaciones'}</h2>
              <p>${onlyActive ? 'Desactiva el filtro para ver todas' : 'Crea tu primera invitaci√≥n para empezar'}</p>
            </div>
          `;
          return;
        }

        const grid = filtered.map(inv => `
          <div class="invitation-card">
            <div class="card-header">
              <h3 class="card-title">${inv.babyName || 'Sin nombre'}</h3>
              <div class="card-color" style="background-color: ${inv.color || '#3498DB'};"></div>
              ${inv.tokenExpiresAt ? (Date.now() > inv.tokenExpiresAt ? `<span class="badge badge-danger" title="Token vencido">Vencido</span>` : `<span class="badge badge-success" title="Token activo">Activo</span>`) : ''}
              ${inv.tokenExpiresAt && Date.now() > inv.tokenExpiresAt ? `<button class="badge-action" onclick="extendToken('${inv.id}')" title="Extender token">Extender +7d</button>` : ''}
            </div>
            <div class="card-info">
              <div class="info-row">
                <span class="info-label">Beb√©:</span>
                <span>${inv.babyName || '-'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Pap√°s:</span>
                <span>${inv.fatherName && inv.motherName ? inv.fatherName + ' & ' + inv.motherName : '-'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Fecha:</span>
                <span>${inv.eventDate ? new Date(inv.eventDate).toLocaleDateString('es-ES') : '-'}</span>
              </div>
              ${inv.tokenExpiresAt ? `
              <div class="info-row">
                <span class="info-label">Enlace:</span>
                <span>
                  ${Date.now() > inv.tokenExpiresAt ? 'Vencido' : 'Activo'}
                  <span class="expiry-muted"> ¬∑ Vence: ${formatExpiry(inv.tokenExpiresAt)}${Date.now() <= inv.tokenExpiresAt && daysRemaining(inv.tokenExpiresAt) <= 3 ? ` ¬∑ Faltan ${daysRemaining(inv.tokenExpiresAt)} d√≠a(s)` : ''}</span>
                </span>
              </div>
              ` : ''}
              <div class="info-row">
                <span class="info-label">ID:</span>
                <span style="font-size: 0.85rem; font-family: monospace; color: #999;">${inv.id.substring(0, 8)}...</span>
              </div>
            </div>
            <div class="card-actions">
              <button class="btn btn-primary" onclick="viewConfirmations('${inv.id}', '${inv.babyName}')">
                ${icon('list')}
                Ver Confirmaciones
              </button>
              <button class="btn btn-secondary" onclick="copyInvitationLink('${inv.id}')">
                ${icon('link')}
                Copiar Link
              </button>
              <button class="btn btn-tertiary" onclick="regenerateToken('${inv.id}')" title="Regenerar token">
                ${icon('refresh')}
                Regenerar Token
              </button>
            </div>
          </div>
        `).join('');

        document.getElementById('dashboardContent').innerHTML = `<div class="dashboard-grid">${grid}</div>`;
      } catch (error) {
        console.error('Error al cargar dashboard:', error);
        document.getElementById('dashboardContent').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">${icon('alert')}</div>
            <h2>Error al cargar</h2>
            <p>${error.message}</p>
          </div>
        `;
      } finally {
        hideLoadingSpinner();
      }
    }

    // El filtro 'Mostrar s√≥lo activas' ahora est√° en el header
    document.addEventListener('DOMContentLoaded', () => {
      const filterCheckbox = document.getElementById('filterActive');
      if (filterCheckbox) {
        filterCheckbox.addEventListener('change', loadDashboard);
      }
    });

    async function extendToken(invitationId) {
      try {
        const invSnap = await window.db.ref('invitations/' + invitationId).once('value');
        const inv = invSnap.val() || {};
        const current = inv.tokenExpiresAt || Date.now();
        const extended = current + 7 * 24 * 60 * 60 * 1000; // +7 d√≠as
        await window.db.ref('invitations/' + invitationId).update({ tokenExpiresAt: extended });
        alert('üóìÔ∏è Token extendido por 7 d√≠as');
        loadDashboard();
      } catch (e) {
        alert('Error al extender token: ' + e.message);
      }
    }

    async function viewConfirmations(invitationId, babyName) {
      const confirmations = await loadConfirmations(invitationId);
      document.getElementById('modalTitle').textContent = `Confirmaciones para ${babyName}`;
      
      if (confirmations.length === 0) {
        document.getElementById('modalBody').innerHTML = '<p style="text-align: center; color: #999;">A√∫n no hay confirmaciones</p>';
      } else {
        const total = confirmations.reduce((sum, c) => sum + (parseInt(c.count) || 1), 0);
        const items = confirmations.map(c => `
          <div class="confirmation-item">
            <p class="confirmation-name">${c.name} (${c.count} ${c.count === 1 ? 'persona' : 'personas'})</p>
            <p class="confirmation-details"><span class="icon-inline">${icon('phone')}</span>${c.phone}</p>
            ${c.message ? `<p class="confirmation-details"><span class="icon-inline">${icon('chat')}</span>"${c.message}"</p>` : ''}
          </div>
        `).join('');
        
        document.getElementById('modalBody').innerHTML = `
          <div style="background: #f0f7ff; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
            <strong style="color: #667eea; font-size: 1.2rem;">Total: ${total} personas confirmadas</strong>
          </div>
          ${items}
        `;
      }
      
      document.getElementById('modal').classList.add('visible');
    }

    function copyInvitationLink(invitationId) {
      // Leer invitaci√≥n completa para conocer categor√≠a y token
      window.db.ref('invitations/' + invitationId).once('value').then(snap => {
        const inv = snap.val() || {};
        const token = inv.token;
        const category = inv.category === 'girl' ? 'girl' : 'boy';
        const basePath = window.location.pathname.replace('admin-dashboard.html', '');
        const url = `${window.location.origin}${basePath}pages/${category}/preview.html?id=${invitationId}${token ? `&t=${token}` : ''}`;
        if (inv.tokenExpiresAt && Date.now() > inv.tokenExpiresAt) {
          alert('‚ö†Ô∏è El token est√° vencido. Considera regenerarlo antes de compartir.');
        }
        return navigator.clipboard.writeText(url).then(() => {
          alert('‚úÖ Enlace copiado al portapapeles');
        });
      }).catch(() => {
        alert('No se pudo obtener la invitaci√≥n. Verifica la invitaci√≥n.');
      });
    }

    async function regenerateToken(invitationId) {
      const confirm = window.confirm('¬øDeseas regenerar el token? Los enlaces antiguos dejar√°n de funcionar.');
      if (!confirm) return;
      try {
        const newToken = (typeof window.generateShortToken === 'function') ? window.generateShortToken(8) : Math.random().toString(36).slice(2, 10);
        // Recalcular caducidad: si existe fecha del evento, fin de ese d√≠a; si no, +30 d√≠as
        const invSnap = await window.db.ref('invitations/' + invitationId).once('value');
        const inv = invSnap.val() || {};
        let tokenExpiresAt = Date.now() + 30 * 24 * 60 * 60 * 1000;
        if (inv.eventDate) {
          const d = new Date(inv.eventDate);
          d.setHours(23, 59, 59, 999);
          tokenExpiresAt = d.getTime();
        }
        await window.db.ref('invitations/' + invitationId).update({ token: newToken, tokenExpiresAt });
        alert('üîê Token regenerado correctamente. Copia el nuevo enlace actualizado.');
      } catch (e) {
        alert('Error al regenerar token: ' + e.message);
      }
    }

    document.addEventListener('DOMContentLoaded', loadDashboard);
  </script>
</body>
</html>
